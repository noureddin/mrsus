#!/usr/bin/env perl
# vim: set foldmethod=marker foldmarker={{{,}}} :
use v5.14; use warnings; use autodie; use utf8;
use open qw[ :encoding(UTF-8) :std ];

# must be in the directory this script is called from,
# or provided as the first argument; keep it updated.
my $in = $ARGV[0] // 'HadeethEnc.com_en-v1.11.0.xlsx';

my @ch = (  # {{{
  # Chapters are extracted semi-automatically from the Arabic PDFs.
  # A small number of ahadeeth are in the Excel but not in the PDF; I added them from the website.
  # Ahadeeth seem to be sorted alphabetically in each chapter by title. So do I.

  'القرآن الكريم وعلومه' => [qw[
    10851 5383 10852 10113 10913 10116 4217 10119 10842 10834 5658 10856 10840
    64642 10112 10114 5213 8401 10853 5775 10850 5907 4448 10575 5913 10847
    10838 58197 5965 10899 5464 10574 3571 3349 58145 8402 10843 3335 6178 3377
    58176 10841 10854 6208 3772 6212 3410 10558 6258 58137 6260 6265 6274 6275
    6276 10836 6828

    65051 65054 65046 65059 65060 65058 65099
  ]],

  'الحديث وعلومه' => [qw[
    3633 3686 10849 6982

    65043 65076 65057 65005 65077
  ]],

  'العقيدة' => [qw[
    11178 11201 6615 3725 6361 8317 10094 64605 3393 3563 11214 8887 5493 6468
    3276 10414 10645 11169 8289 3122 3383 6330 10996 8303 5927 11197 3594 11152
    11171 6332 3336 4206 10101 10115 6362 3389 11170 10105 3265 6458 10096 3382
    3667 11203 6329 11202 6461 5737 10562 6462 4555 2945 3624 8947 8283 10998
    10564 5939 3354 3369 5544 10859 4216 4316 4317 11164 8292 10415 8293 6337
    4322 5811 6326 8290 8302 8315 8918 8908 10569 10880 11210 8342 10857 11196
    5979 3160 10549 3339 5800 11190 64673 10553 10855 3375 10992 11208 10650
    6980 3390 10621 5657 3391 10995 3776 8307 3347 3028 10405 3395 6454 5931
    5446 2962 10546 8927 4211 10567 8296 3366 4933 11172 3381 3131 11213 3503
    11194 6049 58210 5934 3005 3573 3110 10548 8284 3384 4849 10120 11215 8294
    8928 10552 5928 10858 8412 3439 3402 4958 5653 5271 5654 6333 4232 3342
    64600 8345 3087 3438 3024 6363 6761 3394 10887 4288 10100 3138 5001 4929
    5774 4563 4289 8313 11219 4239 4291 8346 4925 3386 3700 3597 5865 5343 3861
    3711 8264 11209 11174 4301 4295 3219 6380 10993 10418 10419 11187 8310
    10410 10570 5359 10861 8268 11206 3435 11221 10560 11168 3554 3069 3421
    3469 6107 3508 3636 5456 6327 3084 11207 10573 8304 3334 10554 64607 11179
    4947 5933 3754 11191 8929 3164 6364 10557 5946 10409 4176 10561 6464 5829
    10545 8905 3145 8910 4950 8951 4815 8959 8950 8312 11000 10647 3406 3352
    11216 11222 11223 3115 64601 3407 3422 8883 5977 4718 3408 3777 10997 64625
    3353 3355 5379 58238 3357 3330 8407 8295 10095 7041 11189 10550 4961 10408
    3556 6338 4245 3800 11148 5954 5825 10860 3118 11220 8299 5380 6144 5981
    10422 3915 10098 4969 4186 2997 6765 5438 3416 4792 4179 3378 3412 3413
    3866 3035 3752 6336 11199 11195 10957 3140 3376 8869 6611 10994 5832 3480
    3159 3038 3010 5989 5986 11173 8266 3414 4183 5345 5353 6762 6763 8964 3359
    8884 3373 3506 3417 5375 10635 6766 3042 3287 3418 3419 4204 11217 5445
    3080 10559 4224 11161 10413 3420 6328 6455 3272 3114 11227 11211 8282 8343
    3743 4812 5462 5459 5460 4242 10420 4816 3576 3155 6207 58266 8301 4303
    6764 4810 4811 3405 3116 8319 3121 5461 3387 3343 8291 3117 11218 3016
    10412 8287

    65030 65015 65032 65013 65094 65011 65037 65009 65093 65038 65008 65023
    65073 65039 65025 65075 65007 65045 65065 65036 65061 65000 65071 65002
    65021 65044 65012 65035 65069 65010 65033 65034 65031 65105 65018 65026
    65004 65020 65001 65022 65019 65040 65028 65016 65003 65050 65068 65027
    65087
  ]],

  'الفقه وأصوله' => [qw[
    5430 3723 10563 10051 8906 58239 58062 10882 3559 8386 3059 3108 2938 5791
    10044 3049 3119 3111 10844 2940 58133 10657 64606 4956 5492 64633 10896
    10884 10652 10024 58068 3582 8408 3583 5794 5889 4311 3588 6826 10608 4971
    10023 64646 4533 6074 10036 64668 10609 3144 7185 3566 5021 8280 10937 5022
    3468 3150 64613 8297 10904 5541 5542 8311 8285 8356 6983 6381 64658 64709
    10633 58198 11262 11267 11263 58081 6160 3599 58171 58164 10015 4236 58217
    10020 6460 4237 4218 58118 3325 64722 8377 3106 8907 3281 3066 11310 10033
    3078 6636 4546 58160 58063 58203 5844 10042 3284 3033 8392 10648 10107
    11244 3533 64682 58061 58098 5788 4549 5940 64652 10938 10927 3013 3143
    11231 3098 11258 10871 8406 5880 10872 10869 10108 5336 11279 10636 10877
    10870 10876 10572 3107 8357 10638 10551 10021 58151 10109 10649 8363 2948
    6637 3290 2961 5543 4314 3053 5273 10104 5215 3101 10117 5025 5026 8404
    8370 58144 11266 11265 58231 4556 5027 8360 58101 5855 4541 6021 10630 4531
    3015 10027 11245 3722 5033 11306 3738 11282 64710 10039 3328 58201 3102
    8948 5885 3295 8405 6159 6029 10030 3461 8892 11232 10600 10615 6077 8361
    5771 8889 5391 8874 8958 5888 58249 2939 2933 2956 2934 2974 4227 4545 3109
    2979 2958 2946 2947 2960 2949 2943 2982 2959 2970 3029 2955 4252 6366 2953
    3230 58156 58136 64630 6038 58135 6089 10640 11287 3262 58106 3530 3456
    3279 8362 58152 58175 8378 58086 10022 10601 64622 10893 3628 3537 58065
    8897 3568 11261 8842 3090 58264 3572 10111 3099 64691 11294 58172 5887 5916
    3600 5731 10915 3086 3307 10885 58200 10925 58161 7200 64663 3065 10881
    3529 3185 2978 3022 5319 10940 5214 3003 10931 8403 11308 4231 58248 58254
    64631 8382 64720 64701 64639 4851 3089 11230 58237 3577 6023 64696 64614
    11256 10932 4830 10046 10928 11249 10934 4247 3095 11248 58102 8359 10916
    10920 10930 10606 8955 5853 5922 10911 8380 8395 10013 58134 5648 64655
    58108 5649 11237 3046 11307 10706 4535 58093 10037 58070 8949 64719 58154
    3174 64694 58216 6024 3485 64697 64700 5881 3052 6022 64667 6973 58074 8381
    2751 64612 8410 11303 6042 6043 58085 11290 10121 64666 10891 64695 10644
    10908 4522 3226 3040 10907 10614 4495 10646 5849 10605 5850 5851 5852 5854
    6036 64643 10903 3051 58167 10875 8872 5827 58104 2937 11242 58157 58199
    58083 8368 64653 3152 58242 10626 58189 64672 10889 5823 8318 4526 64650
    3124 5772 11275 4538 10611 4558 6033 58139 58159 58071 58170 5809 58067
    58105 58088 64703 58072 8953 11295 10922 58150 3655 4290 5650 6113 3512
    3652 3528 11246 10888 8391 58163 3713 3009 3180 4540 4498 4457 2957 2964
    3368 8372 58073 5908 11286 11291 58142 10604 3697 5034 6037 3036 58158 5205
    64597 10406 7187 10623 5964 4292 4536 3707 2750 10969 10901 10622 4853
    58191 6046 58155 3741 58141 4505 4543 2965 58229 5274 10655 5401 58185
    58110 11299 2966 6365 4564 6375 3148 6027 1751 8385 6011 5806 58207 58213
    5813 3714 6041 4439 3309 3717 3023 3175 3464 10939 10656 10618 10929 10653
    8390 8379 2752 6013 11252 10659 58075 58084 6044 58148 3737 11302 6045 3720
    2968 3569 7186 11259 3072 3112 6039 10878 10009 64657 10017 8286 6015 6385
    5321 10919 4532 3031 58263 8369 6048 58186 58103 5219 3064 64620 3444 7188
    5275 3327 5209 11238 10031 5207 58087 8300 5206 6050 10952 10951 4566 11283
    3441 11260 11292 11296 11309 11253 11229 5400 11234 11264 10613 6075 11301
    10921 10945 3062 10909 10912 6016 6017 2971 6018 58149 3025 58168 58082
    58140 3730 5208 3096 4813 58214 58215 10043 58060 10936 5815 3732 4503 2753
    10012 8844 2973 2999 8909 64627 4520 3653 3132 6105 10026 10895 6035 5392
    10568 2976 4537 4529 4960 6387 3565 3546 5805 58184 6162 2977 8399 10967
    10019 5377 11240 6610 8409 6081 64690 6080 11241 6092 8281 10902 64708
    58241 64598 58265 58205 58165 64632 10972 10407 3324 2983 4238 5363 2952
    2975 3758 5204 10102 4826 3516 6612 58138 4565 2754 3316 58132 8383 10052
    5322 11269 10038 8387 58153 8394 4829 10032 10947 10914 4944 11257 6097
    3105 10905 3063 10941 6179 64603 58129 3755 5399 5216 3769 6183 3478 5323
    58130 3103 10906 11280 10643 3293 10943 3455 6185 11243 3100 58124 5212
    10543 58261 6184 10654 10632 6030 58097 3120 10924 2755 6007 58187 64675
    58183 58259 2756 5999 6083 10014 10641 10917 5398 10599 10868 64621 6084
    4454 5817 10028 3388 5217 3076 3348 3396 3075 58252 4539 4528 5861 3085
    2759 3687 4550 2989 6073 4508 8911 6087 3346 64693 6086 58174 5859 6377
    58069 58227 11289 10892 58109 10897 58166 5918 10607 6088 58173 5822 58178
    58146 64640 6025 3088 8384 5378 4542 10603 4711 58247 58147 58226 58066
    4494 11272 4449 3778 4544 2987 7201 3047 6374 64718 6090 58143 58179 58177
    4714 58194 6091 64698 10049 64716 4438 3453 10639 58250 3071 58196 3534
    10637 10986 10008 10873 6094 58091 58077 10629 58078 2988 8963 3785 3409
    10910 58245 58076 58099 64689 8894 58258 3380 3539 10048 58100 4719 5036
    11236 6388 3026 3440 6213 58230 3462 6215 8952 5826 4722 3097 7191 8374
    10612 3854 4519 58246 11235 4547 6020 5828 6217 2984 3864 2991 5512 3914
    4968 3917 4181 2994 2992 2993 2980 2996 2995 5397 5435 4197 4199 5436 2969
    2998 4200 8954 6403 6404 5443 58202 5272 3868 10898 3449 10883 10642 58064
    5831 4965 10933 5381 10918 8364 3379 8871 6254 6255 6392 8388 8917 8288
    6394 4725 8366 5835 6259 3538 58090 5837 6395 6376 4459 5393 10047 6145
    58126 10616 64641 5838 10602 11276 6203 6079 58251 8398 6396 58107 4850
    6397 5842 5433 6261 64721 58212 6263 3313 6264 10035 5394 3437 8965 11251
    2758 3054 11278 6266 4194 4195 10948 8375 11288 10890 8365 11233 4196 4436
    6399 4198 6269 11284 6400 5843 6401 6270 8400 6402 6271 6272 4202 58224
    58195 64637 58208 8413 58244 10950 64660 64623 58125 5218 4530 8397 64706
    4525 11277 5845 3000 3001 2954 5396 8913 3228 5447 4223 64665 10421 3067
    10041 10025 3081 6373 10045 10874 5917 5847 58180 5919 10050 4524 64648
    5921 8914 5848 5920 4523 58190 10010 4527 58211 8376 11281 8396 8355 5856
    4945 5858 6760 8389 10566 10029 3310 10596 3535 5520 2950 3731 3589 58222
    10935 6408 11271 11298 3034 10628 58080 10879 4250 4959 8393 6032 3351
    10016 6031 4548 3557 10040 3104 3496 3450 3004 11270 4450 3518 5863 10011
    64624 58181 3070 8371 8373 58089 11297

    65091 65100 65095 65102 65083 65085 65081 65084 65089 65098 65104 65097
    65101 65017 65090 65096 65082 65080 65088 66392
  ]],

  'الفضائل والآداب' => [qw[
    5373 6604 4302 5787 3520 8309 3331 58240 3261 6334 5929 64599 3041 4307
    3184 6082 5477 5478 5494 5403 4308 58121 6614 4248 8946 3581 5936 5882 3055
    3125 5479 3584 3586 8957 5938 11193 3135 5404 5480 3591 5339 5328 3592 5020
    3593 3137 3044 5488 5483 5484 5489 5487 5485 8956 5482 5491 11300 5469 5470
    5471 5473 3596 3057 3200 3210 5883 5878 5914 6072 5923 5023 5024 5329 3773
    3598 3056 8878 3074 6367 5656 5341 6076 4964 5448 5495 5497 4220 4294 3578
    2935 2936 3564 4304 5357 3173 58192 3017 3332 3579 58122 5356 3472 6034
    5280 5970 3037 8344 8341 58112 58114 3285 5736 5961 58257 3433 5337 5327
    8877 5338 3552 3356 3608 4318 3165 5498 3493 5499 4233 4180 4235 5500 5496
    5796 4534 8886 8305 3507 3607 6986 3479 11205 4315 3601 5797 3133 10118
    5798 8888 5545 5340 5647 4935 5799 5930 3621 58209 8354 8351 8899 4557 5948
    5331 8353 8350 3625 6331 3736 11192 8349 4559 3032 5802 5803 10571 6407
    8879 64681 3305 3300 4560 3127 5807 3708 3043 3227 5342 5332 5474 5475 4817
    3768 6979 3267 5476 3167 2941 4209 2944 3602 4828 5453 3372 2951 3762 3698
    5326 8272 8411 8900 3558 3058 3329 10848 5790 3567 10110 5382 5384 5792
    3788 5884 3575 5402 3333 4943 3574 5793 5942 3729 3446 10103 3463 6009 5733
    6047 11177 3688 4709 3656 4507 5808 3466 6167 6003 5879 58131 3128 3735
    8944 5651 5804 8880 5659 5324 3236 5773 3728 3852 5776 5906 5949 5905 6040
    5909 5951 5952 5910 5035 3587 5911 3492 3658 10971 8316 3702 8901 3706 6987
    10417 3007 5360 6821 3709 3270 3710 5141 11212 6386 3718 3715 2967 4298
    6012 3039 3716 5361 6014 3645 4299 3719 4300 3712 5333 3365 8902 5734 5812
    58113 8903 5503 6057 58115 5362 2981 5504 3570 3733 58193 4814 4932 3298
    6102 5966 6103 8925 4212 5501 3260 3136 6104 6106 4178 3745 10404 3362 6108
    3006 6110 3502 5814 6111 5864 6112 5915 58188 6163 5502 5490 4310 5506 5507
    4949 8898 4704 4948 6177 6335 3126 4927 3753 5937 3317 5968 5505 5971 5886
    58128 6181 3030 3436 6187 3008 6204 3756 6205 5344 5346 3139 3253 6206 3757
    4940 3014 6372 5450 10099 5508 3791 5509 3792 58119 8930 4706 5348 5976
    8960 8961 4951 3770 4952 2985 2986 8881 4219 3771 5334 5347 3350 3231 5364
    3474 6988 8962 4934 6985 3775 8882 5978 3779 8873 8904 5953 6109 5652 4521
    5365 5366 5368 5367 6209 10634 6210 5349 5350 4928 3079 5369 6984 5370 4717
    3073 6211 5824 8352 5821 4244 5486 3705 5142 3130 4313 10416 4820 3795
    10970 10974 6214 4229 4963 4721 3850 3695 3908 5351 3853 3141 5371 3191
    3161 3445 3083 5352 3863 5510 5511 6469 5458 5431 4188 4797 5513 5432 5514
    4193 8895 5516 5517 5440 5439 5442 5518 5434 4801 5932 3876 6218 3134 5810
    5830 6390 3885 3473 4966 5100 8896 8875 4723 6093 3910 6256 6257 5833 3916
    3701 5834 4177 4205 6141 3358 5372 5840 4187 5374 4189 5862 6262 6379 4191
    5354 3415 4192 3689 3157 6267 6268 3442 3360 5732 3504 10576 4201 6273 5437
    5376 8348 8885 3477 4939 3475 3002 5451 8945 5449 6820 5452 58123 5738 3370
    8876 3880 6405 3367 4808 3166 5454 3361 5846 6466 3392 5735 5519 5522 5355
    4243 5912 3585 6182 4809 8934 3562 3703 4716 3021 4182 3027 3855 2932 5521
    58120 3345 4458 6005 3142 4240 3314 3232 5866 3162 8314 6829 5463

    65006 65014 65063 65055 65053 65049 65092 65086 65062 65047
  ]],

  'الدعوة والحسبة' => [qw[
    5935 5037 6382 4953 3154 4309 5941 5330 4938 4234 3011 3734 3553 5789 4491
    5795 3470 3146 5801 3561 3517 8915 3481 3156 3229 3045 3482 8870 3532 3061
    3344 10411 6384 5956 3483 8891 6370 6368 3303 3082 4568 5819 6369 3580
    64687 3123 5412 3012 5335 3911 3341 58223 6383 6371 58218 64654 64688 8890
    8893 64656 3531 3467 3311 4931

    65074
  ]],

  'السير والتاريخ' => [qw[
    10988 10846 8308 5472 64615 8298 6465 4228 4230 4946 4249 3543 3337 4319
    11188 5926 10953 5655 6967 5818 58127 11180 4221 4222 4225 10965 8262 58117
    5210 3220 3177 10837 10968 10982 10862 3068 4440 58116 10976 10975 2963
    4251 4293 3704 3484 10961 6010 10894 4296 4297 11159 10973 10620 8267 4226
    10960 3727 2972 10954 3448 8414 3194 10964 10959 6613 4246 3443 5320 4827
    8265 3153 5860 3018 6180 6186 5816 3321 4936 3019 8367 3476 10958 6981
    10966 4955 3288 11176 10556 10962 3696 3020 10983 10555 10980 6216 3364
    3306 2990 4970 10979 6078 6219 10987 10956 3060 6391 11175 6220 6221 6222
    4967 10955 6406 3447 5457 10963 11268 6389
  ]],

);  # }}}

my %h;

use Data::XLSX::Parser;
my $parser = Data::XLSX::Parser->new;

$parser->add_row_event_handler(sub {  # {{{
  state $i = 0;
  my ($row, $rowDetail) = @_;
  if ($i == 0) {  # meta
    # ++$i; return;
    my ($rev) = $row->[0] =~ /(Last update.*)/;
    my ($chk) = $row->[0] =~ /(Check for updates.*)/; $chk =~ s,http.*,{$&},;
    my $source = "source: {https://HadeethEnc.com/}.<<>>$rev.<<>>$chk.";
    print "title: موسوعة الأحاديث النبوية (بشرح معاصر)\n$source\n\n[h]\n"
         ."title: Translated Prophetic Hadiths (HadeethEnc.com)\n$source\n\n"
  }
  return if ++$i < 3;  # skip first two rows (info & header)

  ### id title_ar title hadith_text_ar hadith_text explanation_ar explanation
  ###  0  1        2     3              4           5              6
  ### benefits_ar benefits grade_ar takhrij_ar grade takhrij lang link
  ###  7           8        9        10         11    12      13   14

  my $id = $row->[0];
  my $grade_ar = "[حديث $row->[9]]";
  my $grade_en = $row->[11] =~ /^\[/ ? $row->[11] : "[$row->[11]]";
  my $txt_ar = $row->[3];
  my $txt_en = $row->[4] =~ s/\x{200e}//gr;
  my $exp_ar = $row->[5];
  my $exp_en = $row->[6] =~ s/\x{200e}//gr;
  my $url = "{$row->[14]}";

  # U+200E is LEFT-TO-RIGHT MARK,
  # but it's used here between English characters, thus unneeded

  # warn "duplicate hadeeth: $id\n" if exists $h{$id};
  # # there are 106 ahadeeth with two entries with the same id

  my $title_for_sort = $row->[1]
    =~ tr[اأإ]
         [أإا]r
    # make Alef Wasla first,
    # then Alef with Hamza Below,
    # then Alef with Hamza Above.
  ; # that's the order used in the Arabic PDF.

  push @{$h{$id}},  # array for duplicates
  [$title_for_sort,
      "<>\n$txt_ar\n\n$grade_ar\n\n"
    ."<h>\n$txt_en\n\n$grade_en\n\n$url\n\n"
    ."<>\n"    ."الشرح: $exp_ar\n\n$url\n\n"
    ."<h>\nExplanation: $exp_en\n\n$url\n\n"
  ]
});
$parser->open($in);
$parser->sheet_by_id(1);  # }}}

my @ids = map { @$_} grep ref, @ch;  # as defined in the chapters

### Stats {{{


do { my %n; for my $id (keys %h) { $n{ scalar @{$h{$id}} }++ }
printf STDERR "count %d occurred %4d times\n", $_, $n{$_} for sort { $a <=> $b } keys %n };

printf STDERR "%-16s %4d\n", 'total ref', scalar @ids;
printf STDERR "%-16s %4d\n", 'total read', scalar keys %h;

printf STDERR "%-16s %4d\n", 'intersection', do { my $n = 0;
  my @c = @ch;
  while (my ($c, $ii) = splice @c, 0, 2) {
    for my $id (@$ii) { $n++ if exists $h{$id} }
  }
  $n };

printf STDERR "%-16s %4d\n", 'only in ref', do { my $n = 0;
  for my $id (@ids) {
    $n++ unless exists $h{$id};
  }
  $n };

printf STDERR "%-16s %4d\n", 'only in read', do { my $n = 0;
  my %ids = map { $_ => undef } @ids;
  for my $id (keys %h) {
    $n++ unless exists $ids{$id};
  }
  $n };

### more stats

# categories and their number of ahadeeth
do { my @c = @ch;
  while (my ($c, $ii) = splice @c, 0, 2) {
    my $n = 0;
    for my $id (@$ii) { $n++ if exists $h{$id} }
    printf STDERR "%-20s %4d\n", $c, $n;
} };

# non-categerized ahadeeth
do { my %ids = map { $_ => undef } @ids;
  for my $id (keys %h) {
    say STDERR $id unless exists $ids{$id};
  }
};

# }}}

do { my @c = @ch;
  while (my ($c, $ii) = splice @c, 0, 2) {
    my @hh = map { map { $_->[1] } @{$h{$_}} }  # remove the title we sort by
      sort { $h{$a}[0][0] cmp $h{$b}[0][0] }    # sort by title
      grep { exists $h{$_} }  # because not every hadeeth is translated
        @$ii;
    $hh[0] =~ s/^<>\n/<>:: $c\n/;  # indicate the category
    print join "\n", @hh;
} };

